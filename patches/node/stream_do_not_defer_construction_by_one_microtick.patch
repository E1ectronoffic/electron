From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Matteo Collina <hello@matteocollina.com>
Date: Thu, 7 Mar 2024 17:28:25 +0100
Subject: stream: do not defer construction by one microtick
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fixes: https://github.com/nodejs/node/issues/51993
PR-URL: https://github.com/nodejs/node/pull/52005
Reviewed-By: Robert Nagy <ronagy@icloud.com>
Reviewed-By: MichaÃ«l Zasso <targos@protonmail.com>

diff --git a/lib/internal/streams/destroy.js b/lib/internal/streams/destroy.js
index 28802cae5eff32b17d869be5f79b28be84bc09d5..96e61491f08cfc32e1ba780b8136ec02fc38e7b9 100644
--- a/lib/internal/streams/destroy.js
+++ b/lib/internal/streams/destroy.js
@@ -291,7 +291,7 @@ function constructNT(stream) {
     } else if (err) {
       errorOrDestroy(stream, err, true);
     } else {
-      process.nextTick(emitConstructNT, stream);
+      stream.emit(kConstruct);
     }
   }
 
@@ -304,10 +304,6 @@ function constructNT(stream) {
   }
 }
 
-function emitConstructNT(stream) {
-  stream.emit(kConstruct);
-}
-
 function isRequest(stream) {
   return stream?.setHeader && typeof stream.abort === 'function';
 }
