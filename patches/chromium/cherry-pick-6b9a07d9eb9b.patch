From 6b9a07d9eb9b720b6e6ccc899c0d1010fa12b5ed Mon Sep 17 00:00:00 2001
From: Mason Freed <masonfreed@chromium.org>
Date: Mon, 20 Jul 2020 19:55:49 +0000
Subject: [PATCH] Reland "Fix UAF in SelectType"

This is a reland of 72158deaf3751325f1983c87829f65441ee32de3

The only change made here is to add the new test to LeakExpectations,
pointing to crbug.com/1103082. Local testing shows that this leak
is triggered by the new test, both before and after this patch. And
since the patch fixes a UAF security bug, I'd like to land it with the
test, and then work on the leak.

Fixed: 1102408
Bug: 1103082

TBR=masonfreed@chromium.org

Original change's description:
> Fix UAF in SelectType
>
> This fixes the UAF detected by ClusterFuzz in [1], caused by [2].
> The test case added here is a minimized version of the clusterfuzz
> case, and I verified that it crashes (ASAN UAF) before this patch
> and no longer crashes after.
>
> [1] https://clusterfuzz.com/testcase-detail/6224868955193344
> [2] https://chromium-review.googlesource.com/c/chromium/src/+/1912682
>
> Fixed: 1102408
> Change-Id: Ieb6a9582ff5b9676596048920bbcff881fdc2eb2
> Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2283901
> Commit-Queue: Mason Freed <masonfreed@chromium.org>
> Auto-Submit: Mason Freed <masonfreed@chromium.org>
> Reviewed-by: Kent Tamura <tkent@chromium.org>
> Cr-Commit-Position: refs/heads/master@{#785970}

(cherry picked from commit e1c45006a8e5a97778eeed0010a7f57d86e70ca4)

Change-Id: I471cb4abc98a7627803de4e434e0453cb729c15f
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2288372
Auto-Submit: Mason Freed <masonfreed@chromium.org>
Reviewed-by: Kent Tamura <tkent@chromium.org>
Commit-Queue: Mason Freed <masonfreed@chromium.org>
Cr-Original-Commit-Position: refs/heads/master@{#786562}
Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/2307621
Reviewed-by: Mason Freed <masonfreed@chromium.org>
Cr-Commit-Position: refs/branch-heads/4147@{#902}
Cr-Branched-From: 16307825352720ae04d898f37efa5449ad68b606-refs/heads/master@{#768962}
---
 .../renderer/core/html/forms/select_type.cc     |  2 +-
 third_party/blink/web_tests/LeakExpectations    |  4 ++++
 ...lect-change-layout-object-crash-expected.txt |  1 +
 .../select-change-layout-object-crash.html      | 17 +++++++++++++++++
 4 files changed, 23 insertions(+), 1 deletion(-)
 create mode 100644 third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash-expected.txt
 create mode 100644 third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash.html

diff --git a/third_party/blink/renderer/core/html/forms/select_type.cc b/third_party/blink/renderer/core/html/forms/select_type.cc
index 11fda22f82a94..6048bc713fc04 100644
--- a/third_party/blink/renderer/core/html/forms/select_type.cc
+++ b/third_party/blink/renderer/core/html/forms/select_type.cc
@@ -722,7 +722,7 @@ bool ListBoxSelectType::DefaultEventHandler(const Event& event) {
 
       if (Page* page = select_->GetDocument().GetPage()) {
         page->GetAutoscrollController().StartAutoscrollForSelection(
-            layout_object);
+            select_->GetLayoutObject());
       }
     }
     // Mousedown didn't happen in this element.
diff --git a/third_party/blink/web_tests/LeakExpectations b/third_party/blink/web_tests/LeakExpectations
index e16c9cbc52403..b1e8fa010aa85 100644
--- a/third_party/blink/web_tests/LeakExpectations
+++ b/third_party/blink/web_tests/LeakExpectations
@@ -153,6 +153,10 @@ crbug.com/1068175 [ Linux ] external/wpt/referrer-policy/gen/worker-classic.http
 # Sheriff 2020-05-06
 crbug.com/1078769 [ Linux ] external/wpt/wasm/jsapi/idlharness.any.html [ Pass Failure ]
 
+# This test triggers existing leaky behavior, but this test also catches
+# a prior crash.
+crbug.com/1103082 [ Linux ] fast/forms/select/select-change-layout-object-crash.html [ Failure ]
+
 ###########################################################################
 # WARNING: Memory leaks must be fixed asap. Sheriff is expected to revert #
 # culprit CLs instead of suppressing the leaks. If you have any question, #
diff --git a/third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash-expected.txt b/third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash-expected.txt
new file mode 100644
index 0000000000000..cbe81f73ef4a3
--- /dev/null
+++ b/third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash-expected.txt
@@ -0,0 +1 @@
+PASS - this test passes if it does not crash (ASAN)
diff --git a/third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash.html b/third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash.html
new file mode 100644
index 0000000000000..8e9361dd7cd1f
--- /dev/null
+++ b/third_party/blink/web_tests/fast/forms/select/select-change-layout-object-crash.html
@@ -0,0 +1,17 @@
+<style>
+.c:hover { display: block; }
+</style>
+
+<select id=target autofocus=autofocus size=2 class=c></select>
+
+<script>
+if (window.testRunner)
+	testRunner.dumpAsText();
+
+window.onload = function() {
+    eventSender.beginDragWithFiles( ["resources/file-for-drag-to-navigate.html"]);
+    eventSender.mouseMoveTo(target.offsetLeft + 5, target.offsetTop + 5);
+};
+</script>
+
+<p>PASS - this test passes if it does not crash (ASAN)</p>
